# Chess App - AI Context

## Project Overview

Real-time two-player chess app. Monorepo with Rust backend and React frontend. No authentication — player identity via UUID secrets in localStorage.

## Tech Stack

| Layer | Tech |
|-------|------|
| Backend | Rust, Axum 0.8, Tokio, shakmaty 0.27 |
| Database | PostgreSQL (Neon), sqlx 0.8 |
| Frontend | React 19, Vite 6, TypeScript, TanStack Router + Query |
| Real-time | WebSocket (Axum WS + broadcast channels) |
| Board | Canvas 2D with HiDPI scaling, drag-only interaction |

## Project Structure

```bash
/code/chess/
├── Makefile                          # dev, setup, db-migrate
├── backend/
│   ├── Cargo.toml
│   ├── .env                          # DATABASE_URL (gitignored)
│   ├── migrations/
│   │   └── 20240101000000_create_games.sql
│   └── src/
│       ├── main.rs                   # Axum router, binds 0.0.0.0:3000
│       ├── state.rs                  # AppState: PgPool + DashMap<Uuid, broadcast::Sender>
│       ├── error.rs                  # AppError -> HTTP responses
│       ├── protocol.rs               # ServerMessage / ClientMessage enums (serde tagged)
│       ├── chess/mod.rs              # shakmaty wrapper: validate, apply, legal_moves, fen conversion
│       ├── db/
│       │   ├── pool.rs              # PgPool with Neon cold-start retry (3 attempts, exp backoff)
│       │   ├── models.rs            # GameRow, GameStatus enum, GameResponse, GameWithSecret
│       │   └── queries.rs           # SQL CRUD: create, get, list, join, update_state
│       └── routes/
│           ├── games.rs             # REST: POST create, GET list, GET by id, POST join, POST move
│           └── ws.rs                # WS /ws/games/{id}: game_state on connect, move/resign handling
└── frontend/
    ├── vite.config.ts                # proxy /api->:3000, /ws->ws://:3000, @/ alias
    ├── public/pieces/                # 12 SVGs: {w,b}{K,Q,R,B,N,P}.svg (cburnett style)
    └── src/
        ├── main.tsx                  # QueryClientProvider + RouterProvider
        ├── routeTree.gen.ts          # Auto-generated by TanStack Router plugin
        ├── api/
        │   ├── client.ts            # Fetch wrapper with /api base
        │   ├── types.ts             # Game, GameWithSecret, ServerMessage, ClientMessage
        │   └── hooks.ts             # useGames, useGame, useCreateGame, useJoinGame
        ├── hooks/
        │   ├── useGameWebSocket.ts  # WS with auto-reconnect (exp backoff, 10s cap)
        │   └── usePieceImages.ts    # Preloads 12 SVG piece images as HTMLImageElement
        ├── canvas/
        │   ├── coordinates.ts       # pixelToSquare, squareToPixelCenter (handles board flip)
        │   ├── types.ts             # DragState, BoardTheme
        │   ├── boardRenderer.ts     # drawBoard (squares, highlights, pieces, coords), drawDragPiece
        │   └── interactionHandler.ts # Drag-only moves, click deselects, document mousedown for outside
        ├── components/
        │   ├── ChessBoard.tsx       # Two stacked canvases (board + drag), HiDPI via devicePixelRatio
        │   ├── GameInfo.tsx         # Status, turn, resign button
        │   ├── MoveHistory.tsx      # Scrollable SAN move list
        │   ├── GameCard.tsx         # Game preview for home page
        │   └── CreateGameButton.tsx
        ├── routes/
        │   ├── __root.tsx           # Layout with nav header
        │   ├── index.tsx            # Home: game list + create
        │   └── game/$gameId.tsx     # Game page: board + info + history, optimistic moves
        └── lib/
            ├── chess.ts             # parseFen, fenTurn, squareToAlgebraic, applyLocalMove
            └── storage.ts           # localStorage: saveSecret, getSecret, clearSecret
```

## Database Schema

Single table `games` with enum type `game_status`:

```sql
game_status: waiting | active | checkmate | stalemate | draw | resigned

games: id (UUID PK), white_secret, black_secret (nullable),
       fen, moves (TEXT[]), status, result (nullable),
       created_at, updated_at
```

- `white_secret` generated on create, `black_secret` on join
- `moves` stores SAN notation history
- `result` is "white" or "black" or null

## API

### REST Endpoints

- `POST /api/games` -> GameWithSecret (white_secret)
- `GET  /api/games` -> Game[] (50 most recent)
- `GET  /api/games/{id}` -> Game (no secrets)
- `POST /api/games/{id}/join` -> GameWithSecret (black_secret)
- `POST /api/games/{id}/moves` -> Game (fallback, also broadcasts via WS)

### WebSocket `/ws/games/{id}`

Server -> Client: `game_state`, `move_made`, `player_joined`, `game_over`, `error`
Client -> Server: `make_move { move, secret }`, `resign { secret }`

All messages are JSON with `type` field (snake_case tagged enum).
Server sends full `legal_moves` list with every state update.

## Key Architecture Decisions

**Two-canvas rendering**: Bottom canvas = board + pieces (redraws on state change). Top canvas = drag overlay (redraws on mousemove only). Avoids full redraw during drag.

**HiDPI**: Canvas pixel size = CSS size * devicePixelRatio. Drawing uses CSS-space coords via `ctx.setTransform(dpr, 0, 0, dpr, 0, 0)`.

**Optimistic moves**: `applyLocalMove()` in chess.ts handles piece movement, castling, en passant, promotion locally. Displayed immediately, cleared on server confirmation or rolled back on error.

**Broadcast channels**: `DashMap<Uuid, broadcast::Sender<ServerMessage>>` in AppState. One channel per game for WS fan-out.

**No client-side engine**: Server sends full legal move list. Client just matches against that list for validation/display.

## Common Pitfalls

- **shakmaty API**: Use `UciMove` (not deprecated `Uci`). Convert position to FEN via `pos.clone().into_setup(EnPassantMode::Legal)`.
- **TanStack Router**: Route tree is auto-generated by Vite plugin. Don't edit `routeTree.gen.ts` manually.
- **Neon cold starts**: Pool has retry with exponential backoff. First connection may take a few seconds.
- **WebSocket state**: Always process `game_state` messages (don't skip with guards) — they contain the authoritative legal_moves.

## Development

```bash
make setup      # npm install + cargo install watchexec-cli + sqlx-cli
make db-migrate # Run SQL migrations
make dev        # Frontend :5173 + Backend :3000 (parallel, with hot reload)
```

Backend requires `DATABASE_URL` in `backend/.env`. Copy from `.env.example`.
